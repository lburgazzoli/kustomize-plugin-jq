apiVersion: kustomize.lburgazzoli.github.io/v1alpha1
kind: JQTransform
metadata:
  name: jq-transformer
  annotations:
    config.kubernetes.io/function: |
      container:
        image: quay.io/lburgazzoli/kustomize-plugin-jq:latest
spec:
  replacements:
    - source:
        group: components.lburgazzoli.github.io
        version: v1alpha1
        kind: Configuration
        name: 'foo-config'
        expression: '.spec.configuration.resources.type == "fixed"'
      targets:
        - group: apps
          version: v1
          kind: Deployment
          name: 'foo-deployment'
          expressions:
            - '(.spec.template.spec.containers[] | select(.name == "manager")).resources.limits |= $foo_config.spec.configuration.resources.fixed.resources.limits'
            - '.spec.template.spec.containers[0].resources.requests = $foo_config.spec.configuration.resources.fixed.resources.requests'
            - '.spec.replicas = $foo_config.spec.configuration.resources.fixed.replicas'